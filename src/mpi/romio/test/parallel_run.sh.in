#!/bin/sh
#
# Copyright (C) 2018, Northwestern University
# See COPYRIGHT notice in top-level directory.
#

# Exit immediately if a command exits with a non-zero status.
set -e
# Below line turn on echo mode
# set -x

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
mpirun="@MPIRUN@"

# valgrind_opt="libtool --mode=execute valgrind --quiet --leak-check=full"

exe_name=`basename $1`

FILENAME="romio_test"_$exe_name

rm -f ${FILENAME}*

if test "x$exe_name" = xfile_info ; then
   for fs in @FILE_SYSTEM@ ; do
       if [ $fs = "testfs" ] ; then
          $mpirun -np 4 ${valgrind_opt} $1 -f $FILENAME
       elif [ $fs = "ufs" ] ; then
          $mpirun -np 4 ${valgrind_opt} $1 -u -f $FILENAME
       elif [ $fs = "gpfs" ] ; then
          $mpirun -np 4 ${valgrind_opt} $1 -b -f $FILENAME
       elif [ $fs = "lustre" ] ; then
          $mpirun -np 4 ${valgrind_opt} $1 -l -f $FILENAME
       fi
    done
elif test "x$exe_name" = xaggregation1 ; then
   $mpirun -np 4 ${valgrind_opt} ./aggregation1 -h -f $FILENAME
elif test "x$exe_name" = xperf        ||
     test "x$exe_name" = xcoll_perf   ||
     test "x$exe_name" = xlarge_array ||
     test "x$exe_name" = xlarge_file  ||
     test "x$exe_name" = xexternal32 ; then
   # $mpirun -np 4 ${valgrind_opt} $1 -h -f $FILENAME
   echo "skip testing $1"
elif test "x$exe_name" = xnoncontig        ||
     test "x$exe_name" = xi_noncontig      ||
     test "x$exe_name" = xnoncontig_coll   ||
     test "x$exe_name" = xtypes_with_zeros ; then
   $mpirun -np 2 ${valgrind_opt} $1 -f $FILENAME
elif test "x$exe_name" = xsyshints ; then
   $mpirun -np 1 ${valgrind_opt} $1 -f $srcdir/test_hintfile
elif test "x$exe_name" = xpio_noncontig ; then
   $mpirun -np 2 ${valgrind_opt} $1 -n 4 -c 2048 -f $FILENAME
elif test "x$exe_name" = xlarge_dtype ; then
   $mpirun -np 2 ${valgrind_opt} $1 -n 4 -l 16 -f $FILENAME
elif test "x$exe_name" = xnvars ; then
   $mpirun -np 2 ${valgrind_opt} $1 -r -f $FILENAME
else
   $mpirun -np 4 ${valgrind_opt} $1 -f $FILENAME
fi

rm -f $FILENAME*

